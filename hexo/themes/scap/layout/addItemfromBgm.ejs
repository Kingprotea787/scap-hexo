<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bangumi 搜索并入库</title>
  <style>
    :root{
      --bg:#0b0e13;
      --panel:#131722;
      --panel2:#0f1420;
      --border:rgba(255,255,255,.08);
      --text:#e7eaf0;
      --muted:#9aa3b2;
      --accent:#4da3ff;
      --danger:#ff5a6a;
      --ok:#25d695;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -200px,#121826,#0b0e13);
      color:var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:0 18px;}
    .title{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px;}
    h1{font-size:22px;margin:0;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;margin:0}
    .grid{display:grid;grid-template-columns: 1.2fr .8fr;gap:16px;}
    .card{
      background: linear-gradient(180deg, rgba(19,23,34,.95), rgba(12,16,26,.95));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{padding:14px 14px 10px;border-bottom:1px solid var(--border);}
    .card-b{padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], select{
      background: var(--panel2);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
    }
    input[type="text"]{min-width:260px;flex:1}
    select{min-width:180px}
    button{
      background: linear-gradient(180deg, rgba(77,163,255,.95), rgba(58,132,255,.95));
      border:0;
      color:#06101d;
      font-weight:700;
      padding:10px 14px;
      border-radius: 12px;
      cursor:pointer;
    }
    button:disabled{
      opacity:.5;cursor:not-allowed;
    }
    .btn-secondary{
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      font-weight: 600;
    }
    .hint{margin-top:10px;font-size:13px;color:var(--muted)}
    .hint.ok{color:var(--ok)}
    .hint.err{color:var(--danger)}
    .list{display:flex;flex-direction:column;gap:10px;}
    .item{
      display:grid;
      grid-template-columns: 18px 68px 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(15,20,32,.55);
    }
    .thumb{
      width:68px;height:92px;border-radius:10px;
      object-fit:cover;background:#0a0f18;border:1px solid var(--border);
    }
    .meta{min-width:0}
    .name{font-size:14px;font-weight:700;line-height:1.25;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .jp{font-size:12px;color:var(--muted);margin:2px 0 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .badge{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;background: rgba(10,15,24,.55);
      white-space:nowrap;
    }
    .preview{
      display:flex;gap:12px;align-items:flex-start;
    }
    .preview img{
      width:92px;height:126px;border-radius:14px;object-fit:cover;
      border:1px solid var(--border);background:#0a0f18;
    }
    .pv h3{margin:0 0 6px;font-size:15px}
    .pv p{margin:0;color:var(--muted);font-size:13px;line-height:1.5;max-height:7.5em;overflow:hidden}
    .small{font-size:12px;color:var(--muted);margin-top:10px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    code{color:#b7c7ff}
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>Bangumi 搜索 → 选中 → 上传入库</h1>
        <p class="sub">页面一：搜索与入库（写入后端 yml）；页面二：读取 yml 展示。</p>
      </div>
      <div class="small">API：<code>/api/bgm-search</code> & <code>/api/bgm-import</code></div>
    </div>

    <div class="grid">
      <!-- Left: Search -->
      <div class="card">
        <div class="card-h">
          <div class="row">
            <label for="keyword">关键词</label>
            <input id="keyword" type="text" placeholder="比如：中二病 / CLANNAD / Fate" />
            <label for="type">分类</label>
            <select id="type">
              <option value="">全部</option>
              <option value="1">小说</option>
              <option value="2" selected>动画</option>
              <option value="3">音乐</option>
              <option value="4">游戏</option>
              <option value="6">三次元</option>
              <option value="5">其它</option>
              <option value="7">漫画</option>
            </select>
            <button id="btnSearch">搜索</button>
            <button id="btnClear" class="btn-secondary" type="button">清空</button>
          </div>
          <div id="hint" class="hint">输入关键词，选择分类，然后点击搜索。</div>
        </div>
        <div class="card-b">
          <div id="resultCount" class="small"></div>
          <div id="results" class="list"></div>
        </div>
      </div>

      <!-- Right: Preview + Upload -->
      <div class="card">
        <div class="card-h">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div>
              <div style="font-weight:800;">已选中条目</div>
              <div class="small">点击“上传入库”会让后端抓详情并写入 yml。</div>
            </div>
            <button id="btnUpload" disabled>上传入库</button>
          </div>
          <div id="uploadHint" class="hint">请先从左侧结果中选中一条。</div>
        </div>
        <div class="card-b">
          <div id="preview" class="preview" style="display:none;">
            <img id="pvImg" alt="" />
            <div class="pv">
              <h3 id="pvTitle"></h3>
              <div class="small" id="pvSub"></div>
              <p id="pvSummary"></p>
              <div class="actions">
                <span class="badge" id="pvType"></span>
                <span class="badge" id="pvYear"></span>
                <span class="badge" id="pvScore"></span>
              </div>
            </div>
          </div>
          <div id="pvEmpty" class="small">（暂无选中条目预览）</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      results: [],
      selected: null,
      loading: false
    };

    function typeLabel(t){
      const m = {
        1:'小说', 2:'动画', 3:'音乐', 4:'游戏', 6:'三次元', 5:'其它' ,7:'漫画'
      };
      return m[t] || `type=${t}`;
    }

    function setHint(text, kind=''){
      const el = $('hint');
      el.textContent = text;
      el.className = 'hint' + (kind ? ` ${kind}` : '');
    }

    function setUploadHint(text, kind=''){
      const el = $('uploadHint');
      el.textContent = text;
      el.className = 'hint' + (kind ? ` ${kind}` : '');
    }

    function setBusy(isBusy){
      state.loading = isBusy;
      $('btnSearch').disabled = isBusy;
      $('btnUpload').disabled = isBusy || !state.selected;
      $('keyword').disabled = isBusy;
      $('type').disabled = isBusy;
    }

    function clearAll(){
      $('keyword').value = '';
      $('type').value = '2';
      $('results').innerHTML = '';
      $('resultCount').textContent = '';
      state.results = [];
      state.selected = null;
      $('btnUpload').disabled = true;

      $('preview').style.display = 'none';
      $('pvEmpty').style.display = 'block';
      setHint('输入关键词，选择分类，然后点击搜索。');
      setUploadHint('请先从左侧结果中选中一条。');
    }

    function renderResults(list){
      const wrap = $('results');
      wrap.innerHTML = '';

      $('resultCount').textContent = list.length ? `搜索结果：${list.length} 条（点击选择）` : '没有结果';
      if (!list.length) return;

      list.forEach((it, idx) => {
        const id = it.id;
        const cn = it.name_cn || '';
        const jp = it.name || '';
        const img = (it.images && (it.images.medium || it.images.small || it.images.large)) || '';
        const score = it.rating?.score ?? '';
        const date = it.date || '';
        const t = it.type;

        const div = document.createElement('div');
        div.className = 'item';

        div.innerHTML = `
          <input type="radio" name="pick" value="${id}" aria-label="选择">
          <img class="thumb" src="${img}" alt="">
          <div class="meta">
            <p class="name" title="${cn || jp}">${cn || jp || '(无标题)'}</p>
            <p class="jp" title="${jp}">${jp || ''}</p>
            <div class="small">${date ? `日期：${date}` : ''}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;">
            <span class="badge">${typeLabel(t)}</span>
            <span class="badge">${score ? `评分：${score}` : '无评分'}</span>
          </div>
        `;

        div.addEventListener('click', () => selectItemById(id));
        div.querySelector('input[type="radio"]').addEventListener('click', (e) => {
          e.stopPropagation();
          selectItemById(id);
        });

        wrap.appendChild(div);
      });
    }

    function selectItemById(id){
      const it = state.results.find(x => String(x.id) === String(id));
      if (!it) return;
      state.selected = it;

      // set radio checked
      document.querySelectorAll('input[name="pick"]').forEach(r => {
        r.checked = (String(r.value) === String(id));
      });

      // preview
      const title = it.name_cn || it.name || '(无标题)';
      $('pvTitle').textContent = title;
      $('pvSub').textContent = it.name && it.name_cn ? it.name : '';
      $('pvSummary').textContent = (it.summary || it.short_summary || '').trim() || '（该条目没有简介）';

      const img = (it.images && (it.images.large || it.images.medium || it.images.small)) || '';
      $('pvImg').src = img || '';
      $('pvImg').alt = title;

      $('pvType').textContent = typeLabel(it.type);
      $('pvYear').textContent = it.date ? `日期：${it.date}` : '日期：未知';
      const score = it.rating?.score;
      $('pvScore').textContent = score ? `评分：${score}` : '评分：无';

      $('preview').style.display = 'flex';
      $('pvEmpty').style.display = 'none';

      $('btnUpload').disabled = state.loading ? true : false;
      setUploadHint(`已选中：${title}（ID=${it.id}）。点击右上角“上传入库”。`, '');
    }
    function toBgmSearchType(uiType){
      if (!uiType) return undefined;
      const n = Number(uiType);
      if (n === 7) return 1; // 漫画也走书籍(1)
      return n;             // 其他 그대로
    }
    async function doSearch(){
      const keyword = $('keyword').value.trim();
      const uiType = $('type').value;
      const subjectType = toBgmSearchType(uiType); // 给后端的 filter.type
      const uiCategory = uiType ? Number(uiType) : undefined; // 额外告诉后端你选的是小说还是漫画

      if (!keyword){
        setHint('请输入关键词。', 'err');
        return;
      }

      setBusy(true);
      setHint('搜索中…', '');
      try{
        const r = await fetch('/api/bgm-search', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ keyword, subjectType, uiCategory })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok){
          setHint(data?.error || `搜索失败（HTTP ${r.status}）`, 'err');
          return;
        }

        // Bangumi v0 搜索通常返回 { data: [...], total: ... }
        const list = Array.isArray(data.data) ? data.data : [];
        state.results = list;
        state.selected = null;
        $('btnUpload').disabled = true;
        $('preview').style.display = 'none';
        $('pvEmpty').style.display = 'block';
        setUploadHint('请先从左侧结果中选中一条。');

        renderResults(list);
        setHint(list.length ? '搜索完成：点击一条结果以选中。' : '没有搜索到结果，换个关键词试试。', list.length ? 'ok' : 'err');
      }catch(e){
        console.error(e);
        setHint('网络或后端异常，搜索失败。', 'err');
      }finally{
        setBusy(false);
      }
    }

    async function doUpload(){
      if (!state.selected) return;

      // 读取页面当前选择的分类：1=小说，7=漫画，2=动画...
      const uiCategory = Number(document.getElementById('type')?.value || 0);

      setBusy(true);
      setUploadHint('上传中…（后端将抓取详情并写入 yml）');
      try{
        const r = await fetch('/api/bgm-import', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            subject_id: state.selected.id,
            uiCategory // ✅ 新增：让后端按你选的分类分到 Novel/Manga 等
          })
        });

        const data = await r.json().catch(()=>({}));
        if (!r.ok){
          setUploadHint(data?.error || `上传失败（HTTP ${r.status}）`, 'err');
          return;
        }
        setUploadHint('上传成功：已写入 yml。你可以去页面二查看展示结果。', 'ok');
      }catch(e){
        console.error(e);
        setUploadHint('网络或后端异常，上传失败。', 'err');
      }finally{
        setBusy(false);
      }
    }


    $('btnSearch').addEventListener('click', doSearch);
    $('btnUpload').addEventListener('click', doUpload);
    $('btnClear').addEventListener('click', clearAll);
    $('keyword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch();
    });

    // init
    clearAll();
  </script>
</body>
</html>
